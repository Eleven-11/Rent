<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heeexy.example.dao.PostBaseDao">
    <select id="countPost" resultType="java.lang.Integer">
        select count(0) from (SELECT
        u.WX_NICK_NAME      poster,
        u.WX_GENDER         posterGender,
        u.WX_AVATAR_URL     posterAvatar,
        f.TYPE_NAME         typeName,
        m.ID                postId,
        m.CREATE_TIME       createTime,
        m.ADDRESS           address,
        m.LABELS            postLabels,
        m.CONTENT           content,
        m.MIN_PRICE         minPrice,
        m.MAX_PRICE         maxPrice,
        m.PHONE             phone,
        m.TOTAL_BROWSE      browse,
        m.TOTAL_COMMENTS    comments,
        m.TOTAL_RESONATE    likes,
        m.DEV_BROWSE        devBrowse,
        m.DEV_RESONATE      devLike,
        m.TOTAL_COLLECTION  collection,
        m.FEE               fee,
        m.ACTIVE_TIME       activeTime,
        (SELECT IFNULL((SELECT id FROM t_user_follow u WHERE u.FAN_ID =#{userId} AND u.FOLLOW_ID=m.USER_ID),'0') ) isFollow
        FROM
        t_wx_user u,
        t_post_base m,
        t_post_type f
        WHERE
        m.TYPE_ID = f.ID
        AND m.IS_LOWER_SHELF = '0'
        AND m.IS_DEL = '0'
        AND u.USER_ID = m.USER_ID
        <if test="typeId !=null and typeId !=''">
            AND m.TYPE_ID = #{typeId}
        </if>
        <if test="postId !=null and postId !=''">
            AND m.ID = #{postId}
        </if>
        <if test="nickName != null and nickName != ''">
            AND u.WX_NICK_NAME LIKE CONCAT(CONCAT('%',#{nickname}),'%')
        </if>
        <if test="keyword !=null and keyword !=''">
            AND (m.CONTENT LIKE CONCAT(CONCAT('%',#{keyword}),'%') OR m.ADDRESS LIKE CONCAT(CONCAT('%',#{keyword}),'%'))
        </if>
        ORDER BY
        ACTIVE_TIME DESC) g
    </select>
    <insert id="insertPostBase" parameterType="com.alibaba.fastjson.JSONObject">
         INSERT INTO t_post_base (
            ID,
            USER_ID,
            TYPE_ID,
            CONTENT,
            MIN_PRICE,
            MAX_PRICE,
            PHONE,
            ADDRESS,
            LABELS,
            TOTAL_BROWSE,
            TOTAL_RESONATE,
            ACTIVE_TIME,
            CREATE_TIME,
            FEE
        )
        VALUES
            (
            #{postId},
            #{posterId},
            #{typeId},
            #{content},
            #{minPrice},
            #{maxPrice},
            #{phone},
            #{address},
            #{labels},
            #{totalBrowse},
            #{totalLike},
            #{activeTime},
            #{createTime},
            #{fee}
            )
    </insert>
    <select id="getPostBaseList" resultType="com.alibaba.fastjson.JSONObject">
        SELECT
        u.WX_NICK_NAME      poster,
        u.WX_GENDER         posterGender,
        u.WX_AVATAR_URL     posterAvatar,
        f.TYPE_NAME         typeName,
        m.ID                postId,
        m.CREATE_TIME       createTime,
        m.ADDRESS           address,
        m.LABELS            postLabels,
        m.CONTENT           content,
        m.MIN_PRICE         minPrice,
        m.MAX_PRICE         maxPrice,
        m.PHONE             phone,
        m.TOTAL_BROWSE      browse,
        m.TOTAL_COMMENTS    comments,
        m.TOTAL_RESONATE    likes,
        m.DEV_BROWSE        devBrowse,
        m.DEV_RESONATE      devLike,
        m.TOTAL_COLLECTION  collection,
        m.FEE               fee,
        m.ACTIVE_TIME       activeTime,
        (SELECT IFNULL((SELECT id FROM t_user_follow u WHERE u.FAN_ID =#{userId} AND u.FOLLOW_ID=m.USER_ID),'0') ) isFollow
        FROM
        t_wx_user u,
        t_post_base m,
        t_post_type f
        WHERE
        m.TYPE_ID = f.ID
        AND m.IS_LOWER_SHELF = '0'
        AND m.IS_DEL = '0'
        AND u.USER_ID = m.USER_ID
        <if test="typeId !=null and typeId !=''">
            AND m.TYPE_ID = #{typeId}
        </if>
        <if test="postId !=null and postId !=''">
        AND m.ID = #{postId}
        </if>
        <if test="nickName != null and nickName != ''">
        AND u.WX_NICK_NAME LIKE CONCAT(CONCAT('%',#{nickname}),'%')
        </if>
        <if test="keyword !=null and keyword !=''">
        AND (m.CONTENT LIKE CONCAT(CONCAT('%',#{keyword}),'%') OR m.ADDRESS LIKE CONCAT(CONCAT('%',#{keyword}),'%'))
        </if>
        ORDER BY
            ACTIVE_TIME DESC
    </select>
    <update id="updatePostBase">
        UPDATE t_post_base
        SET DEV_BROWSE = #{devBrowse},DEV_RESONATE =#{devLike}
        WHERE ID = #{postId}
    </update>
</mapper>